# CREAR LAS CARPETAS Y LOS DECOKERFILES
**Creamos tres directorios**
```bash
mkdir -p ~/haproxy_lab/{apache01,apache02,haproxy}
```
```bash
cd ~/haproxy_lab
```

**En apache01**:
```bash
cat > apache01/Dockerfile <<'EOF'
FROM httpd:2.4
COPY index.html /usr/local/apache2/htdocs/index.html
EOF
```

**Creamos el index.html**
```bash
cat > apache01/index.html <<'EOF'
<!doctype html>
<html><body><h1>Servido por: Servidor Apache 01</h1></body></html>
EOF
```
<img width="683" height="197" alt="image" src="https://github.com/user-attachments/assets/5e34c588-955c-49fc-9fdd-2c9f52eb57f1" />


**En apache02**
```bash
cat > apache02/Dockerfile <<'EOF'
FROM httpd:2.4
COPY index.html /usr/local/apache2/htdocs/index.html
EOF
```
```bash
cat > apache02/index.html <<'EOF'
<!doctype html>
<html><body><h1>Servido por: Servidor Apache 02</h1></body></html>
EOF
```
<img width="665" height="177" alt="image" src="https://github.com/user-attachments/assets/b18f1fca-eb36-43a4-ae61-448083a48d52" />

**En haproxy en el Dockerfile:**
```bash
cat > haproxy/Dockerfile <<'EOF'
FROM haproxy:1.7
COPY haproxy.cfg /usr/local/etc/haproxy/haproxy.cfg
EOF
```
**Creamos haproxy.cfg**
```bash
cat > haproxy/haproxy.cfg <<'EOF'
global
    log /dev/log local0
    log localhost local1 notice
    maxconn 2000
    daemon

defaults
    log global
    mode http
    option httplog
    option dontlognull
    retries 3
    timeout connect 5000
    timeout client 50000
    timeout server 50000

frontend http-in
    bind *:80
    default_backend webservers

backend webservers
    stats enable
    stats auth admin:admin
    stats uri /haproxy?stats
    balance roundrobin
    option httpchk
    option forwardfor
    option http-server-close
    server apache1 ${APACHE_1_IP}:${APACHE_EXPOSED_PORT} check
    server apache2 ${APACHE_2_IP}:${APACHE_EXPOSED_PORT} check
EOF
```
<img width="684" height="714" alt="image" src="https://github.com/user-attachments/assets/885fd456-8e92-4043-9777-29955564f606" />

# CONTRUIMOS LAS IMÁGENES
**Primero nos metemos a, apache01 y ejecutamos:**
```bash
cd ~/haproxy_lab/apache01
```
```bash
docker build -t miapache01 .h
```
<img width="770" height="292" alt="image" src="https://github.com/user-attachments/assets/c288872d-475b-4ed3-844a-2fd92aa1a0b1" />

**Después en apache02:**
```bash
cd ../apache02
```
```bash
docker build -t miapache02 .
```
<img width="765" height="285" alt="image" src="https://github.com/user-attachments/assets/e7ad853c-0641-4866-aa98-e52037b27052" />

**Y finalmente en haproxy**
```bash
cd ../haproxy
```
```bash
docker build -t mihaproxy .
```
<img width="762" height="302" alt="image" src="https://github.com/user-attachments/assets/cb35a83b-d810-4ecd-b21f-8137d32fe451" />

**Comprobamos las imágenes**
```bash
docker images | grep miapache
```
```bash
docker images | grep mihaproxy
```
<img width="731" height="136" alt="image" src="https://github.com/user-attachments/assets/5a0aacc7-15d2-4c1e-bd8f-08dde031bd4d" />

# CREAMOS LA RED DOCKER 'balanceo'
```bash
docker network create balanceo
```
<img width="732" height="68" alt="image" src="https://github.com/user-attachments/assets/f0d7e66c-4d9d-4a37-8e6a-0dca1eddcc7b" />

# LANZAMOS LOS CONTENEDORES APACHE EN LA RED 'balanceo'
```bash
docker run -d --name ap01 --network balanceo miapache01
```
```bash
docker run -d --name ap02 --network balanceo miapache02
```
<img width="771" height="157" alt="image" src="https://github.com/user-attachments/assets/cca2fdb5-5e3c-4369-b946-474da77f4563" />

# LANZAR HAPROXY
```bash
docker run -d --name ha01 --network balanceo -p 8080:80 \
  -e APACHE_1_IP=ap01 -e APACHE_2_IP=ap02 -e APACHE_EXPOSED_PORT=80 \
  mihaproxy
```
<img width="772" height="136" alt="image" src="https://github.com/user-attachments/assets/19891512-223c-4006-b35f-8c52d512dcb7" />

**Comprobamos que ha01 está corriendo**
```bash
sudo docker ps | grep ha01
```
<img width="772" height="90" alt="image" src="https://github.com/user-attachments/assets/9db2b165-5905-46c5-8024-026fec5b41fc" />

# PROBAR EL BALANCEO
**Abrimos el navegador y escribimos estas URL:**
```bash
http://localhost:8080
```
<img width="522" height="157" alt="image" src="https://github.com/user-attachments/assets/9f64b316-d011-4a55-bce8-1fc1742fd268" />
<img width="477" height="187" alt="image" src="https://github.com/user-attachments/assets/5662b476-2a9a-4d7f-8600-d86daea8fd74" />

```bash
http://localhost:8080/haproxy?stats
```
<img width="888" height="499" alt="image" src="https://github.com/user-attachments/assets/dc898161-fd59-4a8f-93a4-21030945c190" />

# USAR UN VOLUMEN COMÚN PARA AMBOS SERVIDORES
## CONTRUIMOS LA NUEVA IMAGEN
**Creamos el volumen 'datosapache' y lanzamos ap01 con el volumen**
```bash
docker run -d --name ap01 --network balanceo -v datosapache:/usr/local/apache2/htdocs/ miapache01
```
<img width="776" height="97" alt="image" src="https://github.com/user-attachments/assets/ce012a91-d76c-4ec4-9d8e-f002f5eae236" />

**Ahora lanzamos ap02**
```bash
docker run -d --name ap02 --network balanceo -v datosapache:/usr/local/apache2/htdocs/ httpd:2.4
```
<img width="774" height="89" alt="image" src="https://github.com/user-attachments/assets/a57ee1c9-28fd-456a-b878-4516dea3e57c" />

**Y finalmente:**

<img width="679" height="179" alt="image" src="https://github.com/user-attachments/assets/32592a04-55f3-4bac-bff8-29ace9a38930" />

















































